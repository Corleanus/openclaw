# Session: Whisper STT — Windows .cmd Execution Fix
Date: 2026-02-13
Session: 1

## Flow
User explained Whisper/ffmpeg stale-PATH pattern (same class as yesterday's port bug). Had wrapper script + config already set by OpenClaw but STT wasn't working. Analysis found 3 bugs: (1) Node's execFile can't run .cmd on Windows, (2) resolveCliOutput only matches exact "whisper" command name — wrappers miss, (3) config args missing --output_dir/--output_format/--verbose. Codex confirmed analysis + flagged .cmd/execFile as critical. OpenClaw tried to self-fix by changing config to cmd.exe /c — broke gateway. I reverted config, fixed all 3 issues in code+config. User upgraded to whisper large model for multi-language.

## Snapshot
None

## Where We Left Off
All STT fixes deployed. Gateway running. Voice transcription working end-to-end on Telegram with whisper large model.

## Work Completed
- Diagnosed 3 bugs preventing Whisper STT from working on Windows
- Fixed Node.js .cmd/.bat execution on Windows (shell mediation in execFile + spawn)
- Fixed arg-based whisper output detection for wrapper scripts
- Fixed config args (added --output_format txt, --output_dir, --verbose False)
- Reverted OpenClaw's broken cmd.exe /c config hack
- Recorded stale-environment gotcha in primer + memory
- Codex review confirmed analysis before implementation
- Build passes (157 files, 0 errors)
- User verified STT working end-to-end

## Files Changed
- `src/process/exec.ts` — Added `needsShellMediation()` function: detects .cmd/.bat on Windows, adds `shell: true` to execFile options in `runExec()` and spawn options in `runCommandWithTimeout()`
- `src/media-understanding/runner.ts` — `resolveCliOutput()`: added arg-based fallback that tries `resolveWhisperOutputPath` and `resolveWhisperCppOutputPath` regardless of command name, so wrapper scripts work
- `~/.openclaw/openclaw.json` — Reverted OpenClaw's cmd.exe hack; restored whisper-wrapper.cmd command with proper args (--output_format txt, --output_dir {{OutputDir}}, --verbose False)
- `docs/architecture/PROJECT_PRIMER.md` — Added stale PATH gotcha under Windows daemon section
- `~/.claude/projects/.../memory/MEMORY.md` — Added Windows Environment Gotchas section

## Decisions Made
- Shell mediation via `shell: true` option (not cmd.exe /c wrapping) — cleaner, works for both execFile and spawn
- Arg-based whisper detection as fallback (not fuzzy name matching) — per Codex recommendation, more robust for any wrapper/alias
- Applied shell mediation to both `runExec` and `runCommandWithTimeout` — same Node.js limitation applies to both

## Learnings
- Node.js `execFile` and `spawn` (without shell option) CANNOT execute .cmd/.bat files on Windows — documented Node.js limitation
- Same stale-environment pattern as yesterday's port bug: process env is birth-time snapshot, never updates
- OpenClaw (the agent) attempted a self-fix that broke the gateway — wrapper execution is a code-level fix, not a config workaround
- Codex review before implementation caught the .cmd/execFile issue that would have been a blocker

## Notes for Next Session
- SearXNG web search deep dive still pending (from Feb 12 handoff)
- 37 pre-existing test failures remain unrelated
- User upgraded to whisper large model — multi-language STT now available
- `bind` stale-closure issue in run.ts still low priority
