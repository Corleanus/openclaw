# Session: Gateway Port Change Bug Fix
Date: 2026-02-12
Session: 4

## Flow
User changed gateway.port to 5555, gateway died. Traced root cause: `run.ts` captures port in a closure at startup, SIGUSR1 restart reuses stale value. Codex caught critical miss — `startGatewayServer` stamps `process.env.OPENCLAW_GATEWAY_PORT` which makes `resolveGatewayPort()` return stale value even with fresh config (env wins over config). Fix: save original env port, pass empty env to bypass stamp on restart. Hit SECOND bug: CLI pre-check rejects approval mode + LAN bind (missing bypass that `server-runtime-config.ts` has). Fixed. Then discovered install.ts also uses `resolveGatewayPort` which reads env over config — install writes stale port to schtasks script. Fixed install.ts + two doctor paths. User confirmed gateway running on 5555.

## Snapshot
None

## Where We Left Off
All port bugs fixed. Gateway running on port 5555 with approval mode + LAN bind. Build passes, tests pass (no new failures).

## Work Completed
- Diagnosed stale port capture bug in gateway SIGUSR1 restart flow
- Got Codex review that caught env var stamping issue (process.env.OPENCLAW_GATEWAY_PORT)
- Fixed port re-resolution in start() closure with env var bypass
- Fixed missing approval mode bypass in CLI LAN bind pre-check
- Fixed install.ts to prefer config port over env for persisted scripts
- Fixed doctor-gateway-daemon-flow.ts (doctor-driven install) — same pattern
- Fixed doctor-gateway-services.ts (doctor service repair) — same pattern
- Build passes (157 files, 0 errors)
- Tests pass (no new failures, pre-existing only)
- Gateway verified running on port 5555

## Files Changed
- `src/cli/gateway-cli/run.ts` — (1) Added `envPortOverride` capture before loop to preserve user-set env var; changed `start()` closure to re-resolve port on each restart iteration using `resolveGatewayPort(loadConfig(), {})` bypassing stamped env. (2) Added `hasApprovalMode` check to CLI LAN bind pre-check.
- `src/cli/daemon-cli/install.ts` — Config port authoritative for install; env is runtime-only override.
- `src/commands/doctor-gateway-daemon-flow.ts` — Same config-over-env fix for doctor-driven install path.
- `src/commands/doctor-gateway-services.ts` — Same config-over-env fix for doctor service repair path.
- `docs/architecture/PROJECT_PRIMER.md` — Added schtasks hardcoded args gotcha and env var stamping gotcha.
- `context/sessions/2026-02-12_session-4.md` — this session log

## Decisions Made
- Port re-resolution uses `resolveGatewayPort(loadConfig(), {})` with empty env to bypass stamped env var
- `envPortOverride` preserves user-set env vars separately from server-stamped ones
- Install paths prefer config port over env — env is a runtime override, not a persisted one
- `bind` has same stale-closure pattern but left unfixed (lower risk, same approach would apply)
- `--force` port-freeing stays as one-shot before loop, not on restart (could kill unrelated services)
- Approval mode CLI pre-check fix matches existing runtime config logic

## Learnings
- `startGatewayServer` stamps `process.env.OPENCLAW_GATEWAY_PORT` — makes `resolveGatewayPort()` return stale values since env takes precedence
- Codex caught what I missed — always verify env var precedence when proposing fixes involving config resolution
- CLI pre-checks in `run.ts` and runtime checks in `server-runtime-config.ts` can diverge
- schtasks scripts hardcode CLI args at install time — all install paths (direct, doctor-flow, doctor-services) must prefer config over env
- The same env-over-config bug appeared in 4 separate locations — systematic pattern worth grepping for

## Notes for Next Session
- SearXNG deep dive still pending from previous handoff
- 37 pre-existing test failures remain unrelated
- `bind` stale-closure issue in run.ts start() closure remains (low priority)
