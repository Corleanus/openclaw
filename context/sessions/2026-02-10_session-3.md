# Session: Code Review + Fixes for Dormancy & TOFU Auth
Date: 2026-02-10
Session: 3

## Flow
Three-round review cycle: Claude team found first-layer issues (sanitizeAgentId divergence, missing extension gates, body size limit, rate limit ordering). Codex found deeper bugs we all missed: Type.Union schema convention, cache key normalization, activate idempotency, authorizeGatewayConnect returning ok:true making WS bypass DEAD CODE (security!), rate limiter track gap, config not wired. Key user realization on authorize: "it's worse than Codex stated." After fixing Codex findings, Codex verification caught regression in our rate limiter fix — pendingCount leak + /pair/status polling breaks. Final fix: separated recordAttempt() (window/cooldown) from track()/release() (pendingCount). Pattern confirmed: Claude implements, Codex reviews.

## Snapshot
Plan file: `C:\Users\Grigorije\.claude\plans\glittery-sniffing-eclipse.md` (from session 2, still valid)

## Where We Left Off
All code review findings fixed and verified. Three rounds complete (Claude review → Codex review → Codex verification). Code not yet build-tested or unit-tested (same as session 2).

## Work Completed
- Cleaned up MCP team (`openclaw-features`) from session 2
- Updated PROJECT_PRIMER.md with dormancy + approval auth subsections
- Claude team code review (3 agents: dormancy core, channel gates, auth security)
- Fixed 5 issues from Claude review (body size limit, sanitizeAgentId, rate limit reorder, field validation, 11 extension gates)
- Codex 3rd-party review (2 parallel reviews: dormancy + auth)
- Fixed 6 issues from Codex review (cache key normalization, activate idempotency, stringEnum schema, authorizeGatewayConnect ok:false, track all attempts, config wiring)
- Codex verification review caught regression in Fix 5
- Fixed rate limiter regression (recordAttempt vs track/release separation)
- Final Codex verification passed (5/6 correct, 1 regression fixed)

## Files Changed
### Review Fixes (Round 1 — Claude findings)
- `src/agents/dormancy/store.ts` - Replaced local sanitizeAgentId with normalizeAgentId, added field validation defaults
- `src/gateway/pair-http.ts` - Added 64KB body size limit to readJsonBody, moved rate limit check before body parsing
- `src/plugins/runtime/types.ts` - Added ApplyDormancyGate type alias to plugin runtime
- `src/plugins/runtime/index.ts` - Wired applyDormancyGate into plugin runtime
- `src/discord/monitor/listeners.ts` - Added dormancy gate to Discord reaction listener
- `extensions/bluebubbles/src/monitor.ts` - Added dormancy gate (messages + reactions)
- `extensions/googlechat/src/monitor.ts` - Added dormancy gate
- `extensions/matrix/src/matrix/monitor/handler.ts` - Added dormancy gate
- `extensions/mattermost/src/mattermost/monitor.ts` - Added dormancy gate
- `extensions/msteams/src/monitor-handler/message-handler.ts` - Added dormancy gate
- `extensions/nextcloud-talk/src/inbound.ts` - Added dormancy gate
- `extensions/tlon/src/monitor/index.ts` - Added dormancy gate
- `extensions/twitch/src/monitor.ts` - Added dormancy gate
- `extensions/zalo/src/monitor.ts` - Added dormancy gate
- `extensions/zalouser/src/monitor.ts` - Added dormancy gate

### Review Fixes (Round 2 — Codex findings)
- `src/agents/dormancy/dormancy.ts` - Cache key normalization (normalizeAgentId in getCachedState/updateState/invalidate), activateAgent idempotency (early return if already active)
- `src/agents/tools/dormancy-tool.ts` - Type.Union replaced with stringEnum for action param
- `src/gateway/auth.ts` - authorizeGatewayConnect returns ok:false for approval mode, added approval config to ResolvedGatewayAuth
- `src/gateway/pair-http.ts` - Rate limiter track() restructured (recordAttempt for all, track/release only for /pair/request)
- `src/gateway/server-http.ts` - GatewayApprovalConfig wired into createPairRateLimiter

### Review Fixes (Round 3 — Codex verification regression)
- `src/gateway/pair-rate-limit.ts` - Added recordAttempt() method (window/cooldown only, no pendingCount), track() now only manages pendingCount
- `src/gateway/pair-http.ts` - recordAttempt at line 129 for all requests, track/release in try/finally only for valid /pair/request

### Primer Update
- `docs/architecture/PROJECT_PRIMER.md` - Added Agent Dormancy subsection, Manual Connection Approval subsection, approval mode exception note in Security

## Decisions Made
- Claude team for implementation, Codex for review — confirmed as the optimal pattern
- Rate limiter: separate recordAttempt() (counts against cooldown+window) from track()/release() (manages pendingCount for in-flight pairing ops)
- authorizeGatewayConnect returns ok:false for approval mode — WS bypass is the actual auth gate, not a redundant check
- activateAgent is idempotent — cursor only set on dormant→active transition, not on repeated activation
- Extension channels get dormancy gate via plugin runtime API (not direct core imports)
- Accepted risk on signature replay in /pair/request (no nonce, dedup prevents abuse)

## Learnings
- authorizeGatewayConnect returning ok:true for approval mode was a subtle security bug — made the 3-line WS bypass dead code and let ALL connections pass auth
- Rate limiter "track everything" approach breaks: pendingCount leaks if release() is removed, and tracking polling endpoints against cooldown breaks normal client behavior
- Repo convention: tool schemas must use stringEnum() not Type.Union — some LLM providers reject nested anyOf JSON Schema
- Codex catches different classes of bugs than Claude review teams — three-round review (Claude→Codex→Codex verify) is thorough
- Agent teams work well for both review and fixes, but single-file surgical fixes might be faster done directly

## Notes for Next Session
- Run `pnpm build` to verify TypeScript compilation (still not done since session 2)
- Run `pnpm test` to check for regressions
- No unit tests written yet for dormancy or pair modules — consider adding
- Architecture docs handoff (`context/handoffs/current.md`) is separate track, unchanged
- GUIDEBOOK.md may need new seam entries for dormancy + approval auth
