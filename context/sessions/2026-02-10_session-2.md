# Session: Agent Dormancy + TOFU Auth Implementation
Date: 2026-02-10
Session: 2

## Flow
Brainstorming session that evolved into architecture and implementation. User wanted: (1) agents that can go dormant while user handles clients manually, waking on demand, (2) connection auth via manual approval instead of tokens. Key realization: dormancy must be runtime state not config (config changes require gateway restart). Second realization: existing device pairing infrastructure is 90% of TOFU auth — just need to skip shared-secret gate. Got Codex second opinion — agreed on design, added cursor/handoff marker and DoS protection. User corrected memory: native Agent Teams preferred over MCP server (MCP only for Codex code review). First two agents ran via MCP (before correction), last two ran natively. All 6 tasks completed.

## Snapshot
Plan file: `C:\Users\Grigorije\.claude\plans\glittery-sniffing-eclipse.md`

## Where We Left Off
All code written by agent team. Not yet build-tested or unit-tested. MCP team (`openclaw-features`) still exists — needs cleanup next session.

## Work Completed
- Designed agent dormancy feature (brainstorm -> Codex review -> architecture -> implementation)
- Designed TOFU auth feature (brainstorm -> Codex review -> architecture -> implementation)
- Implemented dormancy core module (types, store, cache, gate)
- Implemented dormancy tool (`agent_dormancy`) and registered it
- Inserted dormancy gate in 8 channel monitors (WhatsApp, Discord, Telegram x2, Slack, Signal, iMessage, LINE)
- Implemented approval auth mode in config types, auth logic, runtime config
- Implemented pair rate limiter and `/pair` HTTP endpoint (status + request)
- Wired pair handler into gateway HTTP chain
- Added 3-line approval mode bypass in message handler
- Updated memory: native Agent Teams preferred, MCP only for Codex

## Files Changed
- `src/agents/dormancy/types.ts` - NEW: DormancyState type definition
- `src/agents/dormancy/store.ts` - NEW: JSON file persistence for dormancy state
- `src/agents/dormancy/dormancy.ts` - NEW: In-memory cache + public API
- `src/agents/dormancy/gate.ts` - NEW: applyDormancyGate() pipeline check
- `src/agents/tools/dormancy-tool.ts` - NEW: agent_dormancy tool for main agent
- `src/agents/openclaw-tools.ts` - Added dormancy tool registration
- `src/web/auto-reply/monitor/on-message.ts` - Dormancy gate insertion (WhatsApp)
- `src/discord/monitor/message-handler.preflight.ts` - Dormancy gate insertion (Discord)
- `src/telegram/bot.ts` - Dormancy gate insertion (Telegram)
- `src/telegram/bot-message-context.ts` - Dormancy gate insertion (Telegram contexts)
- `src/slack/monitor/message-handler/prepare.ts` - Dormancy gate insertion (Slack)
- `src/signal/monitor/event-handler.ts` - Dormancy gate insertion (Signal)
- `src/imessage/monitor/monitor-provider.ts` - Dormancy gate insertion (iMessage)
- `src/line/bot-message-context.ts` - Dormancy gate insertion (LINE)
- `src/config/types.gateway.ts` - Added "approval" to GatewayAuthMode, GatewayApprovalConfig type
- `src/gateway/auth.ts` - Added approval mode to auth types, resolveGatewayAuth, assertGatewayAuthConfigured, authorizeGatewayConnect
- `src/gateway/server-runtime-config.ts` - Relaxed non-loopback bind restriction for approval mode
- `src/gateway/pair-rate-limit.ts` - NEW: In-memory rate limiter for /pair endpoint
- `src/gateway/pair-http.ts` - NEW: /pair/status and /pair/request HTTP endpoints
- `src/gateway/server-http.ts` - Wired pair handler into HTTP chain
- `src/gateway/server/ws-connection/message-handler.ts` - 3-line approval mode bypass at line 673-679

## Decisions Made
- Dormancy is runtime state (JSON files in ~/.openclaw/agents/), not config — avoids gateway restarts
- Cursor/handoff marker (activatedAt timestamp) prevents agent from replying to conversations already handled by user
- TOFU auth reuses 90% of existing device pairing — only adds auth mode bypass and /pair endpoint
- Store-and-poll for pending connections (not held WebSocket)
- Rate limiter for DoS protection on unauthenticated /pair endpoint
- SAS pairing code: optional, not default (single-operator system)
- Native Agent Teams for teams, MCP only for Codex code review

## Learnings
- Agent Teams have two implementations: native (built-in, preferred) and MCP server (external, for Codex only)
- MCP claude-teams server has encoding issues with special characters on Windows (charmap codec error)
- Existing device pairing infrastructure (requestDevicePairing, approveDevicePairing, getPairedDevice) is remarkably close to what TOFU auth needs
- Config changes to agents/tools/bindings require full gateway restart — runtime state must be stored separately

## Notes for Next Session
- Run `pnpm build` to verify TypeScript compilation
- Run `pnpm test` to check for regressions
- Cleanup MCP team: `mcp__claude-teams__team_delete(team_name="openclaw-features")`
- Zod schema in `src/config/zod-schema.ts` may need "approval" added if it validates auth mode (auth-config agent was instructed to check but verify)
- No unit tests written yet for new modules — consider adding
- PROJECT_PRIMER.md should be updated to mention dormancy and approval auth capabilities
