---
schema: claudex/session-log
version: 1
session_id: b674bfa6-3d76-43c6-8964-1a087123b34c
scope: global
created_at: 2026-02-17T00:10:00Z
source_transcripts: []
handoff_id: cron-catchup-crash-fix
---

# Session: Cron Catch-Up Gateway Crash Diagnosis
Date: 2026-02-17
Session: 1

## Flow
Echo agent added cron catch-up feature (4 source files + schema), then broke the gateway. User asked me to diagnose. Spawned 4 parallel explorer/general-purpose agents to scan: catch-up logic bugs, crash patterns, diff vs original, and cron service tick flow. Root cause: catch-up defaults `lastRunAtMs ?? 0` causing both Nasledstvo jobs to fire immediately on every restart + no `--max-old-space-size` → OOM crash loop. Jobs never complete → lastRunAtMs never persists → infinite loop. Wrote handoff with exact fix locations and code.

## Snapshot
None

## Where We Left Off
Handoff written to `context/handoffs/current.md` with full fix spec. Gateway is DOWN. No code changes made — diagnosis only. Next session applies fixes.

## Work Completed
- Diagnosed gateway crash loop caused by Echo's cron catch-up feature
- Identified 2 root causes: catch-up logic bug + missing memory limit
- Spawned 4 parallel investigation agents for thorough scan
- Verified agent's code changes compile clean (157 files, 0 errors)
- Verified croner `previousRuns()` API is valid
- Confirmed cron tool schema bug is pre-existing (not agent-caused)
- Created detailed handoff with exact fix locations and code snippets

## Files Changed
- `context/handoffs/current.md` — Replaced SearXNG handoff with cron crash fix handoff (full diagnosis + 3 fix specs)

## Decisions Made
- Diagnosis only, no code changes — user explicitly requested report-first approach
- Recommended Fix 1 (skip catch-up when lastRunAtMs undefined) over Fix 2 (use `now` instead of `prevScheduled`) as cleaner semantic approach
- Recommended 8192 MB for --max-old-space-size based on concurrent load pattern

## Learnings
- Echo agent's self-modification pattern: modifies src/ → builds → restarts gateway via SIGUSR1 — risky when running inside the gateway process
- V8 OOM on Windows kills silently with no log output (calls abort())
- Cron catch-up with `lastRunAtMs ?? 0` is a common footgun — epoch time makes any modern timestamp pass the "missed" check
- Gateway had 19 unique PIDs in one day's logs — chronic restart instability

## Notes for Next Session
- Apply Fix 1 (jobs.ts line 85) and Fix 2 (gateway.cmd --max-old-space-size=8192)
- Build, restart gateway, verify catch-up doesn't fire spuriously
- Re-enable catchUp on Nasledstvo jobs after verification
- SearXNG deep dive still pending (handoff was overwritten — context preserved in old session logs)
- Consider: should gateway install --force be re-run after gateway.cmd edit?
