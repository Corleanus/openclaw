# Session: Outbound + WS Handshake Deep Read
Date: 2026-02-08
Session: 2

## Flow
Outbound delivery and WS handshake details weren't fully captured by the earlier gateway-methods read: the real handshake/auth/pairing logic lives in src/gateway/server/ws-connection/message-handler.ts, and send mirroring semantics depend on the shared outbound stack. Consolidated that understanding into architecture/primer docs so next sessions can start refactoring work with the correct mental model.

## Snapshot
None

## Where We Left Off
Cron, TTS, outbound delivery/mirroring, and the remaining gateway WS runtime/lane/maintenance glue are now fully deep-read and documented. Ready to pick the next end-to-end surface to internalize (agents runtime vs plugin/channel layer).

## Work Completed
- Deep-read src/infra/outbound/* end-to-end (targets, directory resolution, cross-context policy, action runner, delivery/chunking, session-key mirroring) including tests.
- Deep-read remaining gateway runtime glue: src/gateway/server-ws-runtime.ts, src/gateway/server-lanes.ts, src/gateway/server-maintenance.ts, plus WS handshake implementation: src/gateway/server/ws-connection.ts and src/gateway/server/ws-connection/message-handler.ts.
- Updated architecture + primer docs to reflect outbound layer and the real WS handshake flow.

## Files Changed
- docs/architecture/architecture.md - expanded gateway boot + WS handshake notes; added outbound messaging section.
- docs/architecture/PROJECT_PRIMER.md - added outbound messaging section; updated WS handshake pointer.
- context/handoffs/current.md - updated to reflect completed deep-reads and next options.
- context/sessions/2026-02-08_session-2.md - session log.

## Decisions Made
- Treat outbound delivery as a shared cross-cutting subsystem (used by CLI message send, agent tool actions, cron isolated agent delivery), not "gateway glue".
- Treat gateway WS handshake as split across ws-connection.ts (connection lifecycle) and ws-connection/message-handler.ts (connect frame validation, auth, device pairing, hello-ok).

## Learnings
- Cross-context messaging is policy-gated (tools.message.crossContext.*) and can decorate sends with markers/embeds.
- Mirroring appends to the target session transcript only after at least one payload is successfully delivered.
- Gateway applies command lane concurrency (cron/main/subagent) early during startup.

## Notes for Next Session
- Choose next deep-read: src/agents/ (Pi runtime + tools/sandbox) vs plugin/channel layer (src/plugins + one extensions/<channel>/src/channel.ts).
